#!/bin/sh /etc/rc.common
# Cloudflare Access JWT Validator

START=95
USE_PROCD=1

PROG="/usr/bin/cf-auth"

start_service() {
    config_load cf-auth

    config_foreach start_instance cf_auth
}

start_instance() {
    local sec="$1"

    local enabled team_domain addr run_user
    config_get_bool enabled     "$sec" enabled 1
    config_get      team_domain "$sec" team_domain
    config_get      addr        "$sec" addr "127.0.0.1:9000"
    config_get      run_user    "$sec" user

    [ "$enabled" -eq 1 ] || return 0

    if [ ! -x "$PROG" ]; then
        echo "cf-auth: $PROG 不存在或不可执行"
        return 1
    fi
    [ -n "$team_domain" ] || { echo "cf-auth: section '$sec' 缺少 team_domain"; return 1; }

    local app_map
    app_map="$(build_app_map "$sec")"
    [ -n "$app_map" ] || { echo "cf-auth: section '$sec' 未配置任何 app 映射"; return 1; }

    procd_open_instance "$sec"

    procd_set_param command "$PROG"
    procd_set_param env TEAM_DOMAIN="$team_domain" APP_MAP="$app_map" ADDR="$addr"

    procd_set_param stdout 1
    procd_set_param stderr 1

    procd_set_param respawn

    [ -n "$run_user" ] && procd_set_param user "$run_user"

    procd_set_param file "/etc/config/cf-auth"

    procd_close_instance
}

build_app_map() {
    local instance_name="$1"
    local map=""
    local _name _inst _auds

    config_foreach _collect_one_app app "$instance_name"

    echo "$__APP_MAP_OUT"
}

_collect_one_app() {
    local sec="$1"
    local target_instance="$2"

    local inst name
    config_get inst "$sec" instance
    [ "$inst" = "$target_instance" ] || return 0

    config_get name "$sec" name
    [ -n "$name" ] || { echo "cf-auth: app '$sec' 缺少 name"; return 0; }

    local auds="" one
    _append_aud() {
        local v="$1"
        [ -z "$auds" ] && auds="$v" || auds="${auds},${v}"
    }
    config_list_foreach "$sec" aud _append_aud

    [ -n "$auds" ] || { echo "cf-auth: app '$sec'(name=$name)缺少 aud"; return 0; }

    if [ -z "$__APP_MAP_OUT" ]; then
        __APP_MAP_OUT="${name}=${auds}"
    else
        __APP_MAP_OUT="${__APP_MAP_OUT};${name}=${auds}"
    fi
}

stop_service() {
    :
}

reload_service() {
    stop
    start
}

service_triggers() {
    procd_add_reload_trigger "cf-auth"
}
